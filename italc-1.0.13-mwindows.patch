From 3f1de933f2bc4bf2ec8f98291cde2366c5e1410e Mon Sep 17 00:00:00 2001
From: Aleksey Avdeev <solo@altlinux.ru>
Date: Tue, 16 Oct 2012 22:09:04 +0400
Subject: [PATCH] Fix use -mwindows flag

Signed-off-by: Aleksey Avdeev <solo@altlinux.ru>
---
 ica/Makefile.am   |    7 ++++++-
 ima/Makefile.am   |    7 ++++++-
 setup/Makefile.am |    7 ++++++-
 3 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/ica/Makefile.am b/ica/Makefile.am
index 379064c..93406e7 100644
--- a/ica/Makefile.am
+++ b/ica/Makefile.am
@@ -97,7 +97,12 @@ WIN32_RES_LDADD = ica_win_resources.o -L. -lvnchooks
 endif
 
 ica_LDADD = $(QT_LDADD) $(QT_LIB_GUI) -lz -ljpeg $(LIBSSL_LDADD) $(IVSLDADD) $(WIN32_RES_LDADD) -L../lib -litalc_core
-ica_LDFLAGS = $(LDFLAGS) -mwindows -rpath $(pkglibdir)
+if BUILD_WIN32
+ica_WIN_LDFLAGS = -mwindows
+else
+ica_WIN_LDFLAGS =
+endif
+ica_LDFLAGS = $(LDFLAGS) $(ica_WIN_LDFLAGS) -rpath $(pkglibdir)
 
 AM_CXXFLAGS = $(QT_CXXFLAGS) -O2 -DBUILD_ICA $(CXXFLAGS_ADD)
 AM_CFLAGS = -O2 -DBUILD_ICA -DVNCSHARED -DFOREVER -DNOREPEAT=0 -DNOPW=1 -DREMOTE_CONTROL=0 -DEXTERNAL_COMMANDS=0 -DFILEXFER=0 -DNOGUI -DSMALL_FOOTPRINT=1 -w
diff --git a/ima/Makefile.am b/ima/Makefile.am
index 6318c6a..e09450d 100644
--- a/ima/Makefile.am
+++ b/ima/Makefile.am
@@ -123,7 +123,12 @@ endif
 
 
 italc_LDADD = $(QT_LDADD) $(QT_LIB_GUI) $(LIBZ_LDADD) -ljpeg $(LIBSSL_LDADD) $(WIN32_RES_LDADD) -L../lib -litalc_core
-italc_LDFLAGS = $(LDFLAGS) -mwindows -rpath $(pkglibdir)
+if BUILD_WIN32
+italc_WIN_LDFLAGS = -mwindows
+else
+italc_WIN_LDFLAGS =
+endif
+italc_LDFLAGS = $(LDFLAGS) $(italc_WIN_LDFLAGS) -rpath $(pkglibdir)
 
 AM_CXXFLAGS = $(QT_CXXFLAGS)
 
diff --git a/setup/Makefile.am b/setup/Makefile.am
index 589e1a2..5bcd780 100644
--- a/setup/Makefile.am
+++ b/setup/Makefile.am
@@ -54,7 +54,12 @@ PLATFORM_LDADD = setup_win_resources.o
 endif
 
 setup_LDADD = $(PLATFORM_LDADD) -L../lib/ -litalc_core $(QT_LDADD) $(QT_LIB_GUI) $(LIBSSL_LDADD) -ljpeg
-setup_LDFLAGS = $(LDFLAGS) -mwindows
+if BUILD_WIN32
+setup_WIN_LDFLAGS = -mwindows
+else
+setup_WIN_LDFLAGS =
+endif
+setup_LDFLAGS = $(LDFLAGS) $(setup_WIN_LDFLAGS)
 
 AM_CXXFLAGS = $(QT_CXXFLAGS)
 
-- 
1.7.3.3

